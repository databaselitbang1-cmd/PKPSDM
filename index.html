<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKPSDM KBSI - Activity Spikes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/dist/date-fns.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
    <link rel="icon" type="image/png" href="https://i.ibb.co.com/HTTY5h8Y/PKPSDM-removebg-preview.png">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; }
        .active-tab { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 700; }
        .hidden { display: none; }
        tbody tr { transition: all 0.3s ease; }
        .spinner { border: 3px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 3px solid #3498db; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-2">
                    <div class="logo_litbang.jpeg" alt="Logo Organisasi" class="h-10 w-auto object-contain">
                        <img src="https://i.ibb.co.com/VbcnYg9/Litbang.jpg" alt="Logo Litbang" class="h-10 w-auto object-contain hover:scale-110 transition-transform cursor-pointer">
                    </div>
                    <span class="font-bold text-xl text-gray-800 tracking-tight">PKPSDM <span class="text-indigo-600">V1.0</span></span>
                </div>
                <div class="flex space-x-2 md:space-x-6 items-center overflow-x-auto">
                    <button onclick="switchTab('dashboard')" id="btn-dashboard" class="tab-btn active-tab px-3 py-2 text-sm text-gray-900 whitespace-nowrap">Dashboard</button>
                    <button onclick="switchTab('search')" id="btn-search" class="tab-btn px-3 py-2 text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap">Cari Anggota</button>
                    <button onclick="accessAdmin()" class="px-4 py-2 bg-gray-900 text-white rounded-md text-xs font-bold hover:bg-gray-700 shadow-lg transition">ADMIN PANEL</button>
                </div>
            </div>
        </div>
    </nav>

    <div id="connection-status" class="bg-yellow-100 text-yellow-800 text-xs text-center py-1 font-medium">
        <span class="spinner mr-2"></span>Menghubungkan ke Cloud...
    </div>

    <div id="view-dashboard" class="max-w-7xl mx-auto px-4 py-8 space-y-6">
        
        <div class="flex flex-col md:flex-row justify-between items-end mb-4">
            <div>
                <div class="flex items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-blue-900">PKPSDM <span class="text-sm text-blue-400 font-normal">V1.0</span></h1>
                        <p class="text-blue-500 text-sm mt-1">Pemantauan Kinerja & Peningkatan Sumberdaya Manusia</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 md:mt-0 text-right">
                <p class="text-xs text-gray-400 mb-1">Snapshot Data:</p>
                <span id="display-mode-label" class="text-sm font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full border border-green-200 shadow-sm">LIVE (Hari Ini)</span>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-800"><i class="text-indigo-500"></i>Grafik Pengembangan SDM Gabungan</h3>
                    <p class="text-[10px] text-gray-400">Naik = Ada Poin Masuk | Turun ke 0 = Pasif</p>
                </div>
                
                <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button onclick="updateChartFilter('weekly')" class="chart-filter px-3 py-1 text-xs rounded-md font-medium text-gray-600 hover:bg-white hover:shadow-sm transition">6 Minggu</button>
                    <button onclick="updateChartFilter('monthly')" class="chart-filter px-3 py-1 text-xs rounded-md font-medium bg-white shadow-sm text-indigo-600">6 Bulan</button>
                    <button onclick="updateChartFilter('yearly')" class="chart-filter px-3 py-1 text-xs rounded-md font-medium text-gray-600 hover:bg-white hover:shadow-sm transition">5 Tahun</button>
                </div>
            </div>
            
            <div class="h-72 relative w-full">
                <canvas id="sdmChart"></canvas>
            </div>
            <p class="text-xs text-center text-indigo-500 mt-2 font-medium bg-indigo-50 p-2 rounded cursor-pointer"><i class="fas fa-hand-pointer mr-1"></i>Klik titik grafik untuk melihat Leaderboard pada periode tersebut.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Leaderboard Point Pengembangan</h3>
                    <button onclick="resetLeaderboardView()" id="btn-reset-view" class="hidden text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200">Reset ke Hari Ini</button>
                </div>
                <div class="overflow-hidden rounded-lg border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Rank</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Anggota</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Divisi</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase">Total Poin</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Kalender Program Kerja</h3>
                <div class="flex-1 overflow-y-auto pr-2" style="max-height: 400px;">
                    <ul id="proker-list" class="space-y-3"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="view-search" class="max-w-6xl mx-auto px-4 py-8 hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-indigo-600">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Cari Rekam Jejak Anggota</h2>
            <div class="flex gap-2 relative max-w-xl mx-auto mb-8">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                <input type="text" id="nim-input" placeholder="Masukkan NIM..." class="w-full pl-10 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                <button onclick="searchNIM()" class="bg-indigo-600 text-white px-6 rounded-lg font-bold hover:bg-indigo-700 transition">Cari</button>
            </div>

            <div id="search-result" class="hidden mt-8 animate-fade-in-up">
                <div class="flex items-start gap-4 mb-6 border-b pb-4">
                    <div class="flex-shrink-0">
                        <img id="res-photo" src="" class="h-24 w-24 rounded-full object-cover border-4 border-indigo-100 bg-gray-100" alt="Foto Profil">
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-gray-900" id="res-name">Nama</h3>
                        <p class="text-gray-500 text-sm"><span id="res-nim">NIM</span> / <span id="res-role">Role</span></p>
                        <p class="text-xs text-indigo-600 mt-1 font-bold" id="res-div">Divisi</p>
                    </div>
                    <div class="text-right">
                        <span class="block text-xs text-gray-400 uppercase tracking-wide">Total Poin</span>
                        <span class="text-4xl font-bold text-indigo-600" id="res-total-points">0</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-700 text-sm">Produktivitas Individu</h4>
                            <div class="flex text-[10px]">
                                <button onclick="renderPersonalChart('weekly')" class="px-2 py-1 bg-white border rounded mr-1 hover:bg-indigo-50">Mingguan</button>
                                <button onclick="renderPersonalChart('monthly')" class="px-2 py-1 bg-white border rounded mr-1 hover:bg-indigo-50">Bulanan</button>
                                <button onclick="renderPersonalChart('yearly')" class="px-2 py-1 bg-white border rounded hover:bg-indigo-50">Tahunan</button>
                            </div>
                        </div>
                        <div class="h-64 w-full">
                            <canvas id="personalChart"></canvas>
                        </div>
                    </div>

                    <div class="border p-4 rounded-lg bg-white border-indigo-100 shadow-sm">
                        <h4 class="font-bold text-gray-700 text-sm mb-2 text-center">Peta Minat</h4>
                        <div class="h-64 w-full relative">
                            <canvas id="interestRadarChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-sm text-gray-700 mb-2 bg-gray-100 p-2 rounded">Rincian Point</h4>
                        <div class="max-h-48 overflow-y-auto border rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 text-gray-500">
                                    <tr>
                                        <th class="px-3 py-2 text-left">Tanggal</th>
                                        <th class="px-3 py-2 text-left">Aktivitas</th>
                                        <th class="px-3 py-2 text-right">Poin</th>
                                    </tr>
                                </thead>
                                <tbody id="res-points-history" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm text-gray-700 mb-2 bg-yellow-50 text-yellow-800 p-2 rounded">Prestasi</h4>
                        <p id="res-achievements" class="text-gray-600 text-sm p-2 border border-yellow-100 rounded bg-white">-</p>
                    </div>
                </div>
            </div>
            <p id="search-error" class="hidden text-center text-red-500 mt-6 font-medium bg-red-50 p-3 rounded">Data NIM tidak ditemukan.</p>
        </div>
    </div>

    <div id="view-admin" class="max-w-7xl mx-auto px-4 py-8 hidden">
        <div class="bg-gray-900 text-white p-4 rounded-t-xl flex justify-between items-center shadow-lg">
            <h2 class="text-lg font-bold"><i class="fas fa-user-shield mr-2"></i>Admin Dashboard</h2>
            <button onclick="switchTab('dashboard')" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded border border-gray-600">Keluar</button>
        </div>
        
        <div class="bg-white p-6 rounded-b-xl shadow-lg border-x border-b border-gray-200 space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="p-4 border rounded-lg bg-gray-50">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2 text-lg">1. Input / Update Data Anggota</h3>
                    <form id="form-member" class="space-y-3">
                        <div class="bg-white p-2 border border-dashed rounded flex items-center gap-2">
                            <i class="fas fa-camera text-gray-400"></i>
                            <input type="file" id="adm-photo" accept="image/*" class="text-xs w-full text-gray-500">
                        </div>

                        <input type="text" id="adm-nim" placeholder="NIM (Wajib)" class="w-full p-2 border rounded focus:border-indigo-500 outline-none">
                        <input type="text" id="adm-name" placeholder="Nama Lengkap" class="w-full p-2 border rounded focus:border-indigo-500 outline-none">
                        
                        <div class="grid grid-cols-2 gap-2">
                            <select id="adm-div" class="w-full p-2 border rounded text-sm bg-white focus:border-indigo-500">
                                <option value="" disabled selected>-- Pilih Divisi --</option>
                                <option value="Litbang">Litbang</option>
                                <option value="Kemhas">Kemhas</option>
                                <option value="Senior">Senior</option>
                                <option value="Soskem">Soskem</option>
                                <option value="Kominfo">Kominfo</option>
                                <option value="Kerohanian">Kerohanian</option>
                                <option value="BPH">BPH</option>
                            </select>

                            <select id="adm-role" class="w-full p-2 border rounded text-sm bg-white focus:border-indigo-500">
                                <option value="Anggota">Anggota</option>
                                <option value="Sekretaris Divisi">Sekretaris Divisi</option>
                                <option value="Kepala Divisi">Kepala Divisi</option>
                                <option value="Sekretaris Umum">Sekretaris Umum</option>
                                <option value="Bendahara Umum">Bendahara Umum</option>
                                <option value="Wakil Ketua Umum">Wakil Ketua Umum</option>
                                <option value="Ketua Umum">Ketua Umum</option>
                            </select>
                        </div>
                        
                        <div class="bg-indigo-50 p-3 rounded border border-indigo-200">
                            <label class="text-xs font-bold text-indigo-800 block mb-1">Tambah Poin Aktivitas:</label>
                            <select id="adm-point-action" class="w-full p-2 border rounded text-sm mb-2 focus:ring-2 focus:ring-indigo-500">
                                <option value="0|No Action">-- Pilih Aktivitas --</option>
                                <option value="1|Rapat Bulanan">1. Rapat Bulanan (1)</option>
                                <option value="1|Saran Forum Divisi">2. Saran Forum Divisi (1)</option>
                                <option value="1|Saran Forum Umum">3. Saran Forum Umum (1)</option>
                                <option value="2|Anggota Panitia">4. Anggota Panitia (2)</option>
                                <option value="2|Sidang Pleno Panitia">5. Sidang Pleno Panitia (2)</option>
                                <option value="3|Kepala Divisi panitia">6. Kepala Divisi panitia (3)</option>
                                <option value="3|Konsolidasi">7. Konsolidasi (3)</option>
                                <option value="4|Sekretaris Panitia">8. Sekretaris Panitia (4)</option>
                                <option value="4|Bendahara Panitia">9. Bendahara Panitia (4)</option>
                                <option value="5|Ketua Panitia">10. Ketua Panitia (5)</option>
                                <option value="5|Inovasi">11. Inovasi (5)</option>
                            </select>
                            <input type="date" id="adm-point-date" class="w-full p-2 border rounded text-sm text-gray-500">
                            <p class="text-[10px] text-gray-500 mt-1">*Tanggal input mempengaruhi lonjakan grafik.</p>
                        </div>

                        <input type="text" id="adm-achievements" placeholder="Prestasi (Manual Text)" class="w-full p-2 border rounded text-sm">
                        <button type="button" onclick="saveMember()" id="btn-save-member" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded shadow">SIMPAN / UPDATE</button>
                    </form>
                </div>

                <div class="p-4 border rounded-lg bg-gray-50 h-fit">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">2. Tambah Program Kerja</h3>
                    <form id="form-proker" class="space-y-3">
                        <input type="text" id="adm-prog-name" placeholder="Nama Program" class="w-full p-2 border rounded">
                        <input type="date" id="adm-prog-date" class="w-full p-2 border rounded">
                        <textarea id="adm-prog-desc" placeholder="Keterangan Program Kerja..." class="w-full p-2 border rounded text-sm h-24 resize-none"></textarea>
                        <select id="adm-prog-status" class="w-full p-2 border rounded">
                            <option value="Belum">Belum Selesai</option>
                            <option value="Selesai">Selesai</option>
                        </select>
                        <button type="button" onclick="addProker()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow">TAMBAH PROKER</button>
                    </form>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-bold text-gray-800 mb-2">Manajemen Data Anggota</h3>
                    <div class="overflow-y-auto h-64 border rounded bg-gray-50">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-200 sticky top-0"><tr><th class="p-2">NIM - Nama</th><th class="p-2 text-center">Aksi</th></tr></thead>
                            <tbody id="admin-member-list" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-gray-800 mb-2">Manajemen Data Proker</h3>
                    <div class="overflow-y-auto h-64 border rounded bg-gray-50">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-200 sticky top-0"><tr><th class="p-2">Program - Tanggal</th><th class="p-2 text-center">Aksi</th></tr></thead>
                            <tbody id="admin-proker-list" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="border-t pt-4 text-center">
                <button onclick="resetAllData()" class="text-red-500 text-xs hover:bg-red-50 px-3 py-1 rounded border border-red-200">Hard Reset (Hapus Semua Database)</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG SUPABASE
        const supabaseUrl = 'https://ponenalepjatfosrffze.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvbmVuYWxlcGphdGZvc3JmZnplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjA3NzQsImV4cCI6MjA3OTgzNjc3NH0.6Ptutr96BuCeTS_GzP8GKDSwYafdhXEjJK8F3Roxyrg'
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey)

        const localeID = 'id-ID';
        const defaultPhoto = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png";
        
        let members = [];
        let prokers = [];
        let chartInstance = null;
        let personalChartInstance = null;
        let interestRadarChart = null; 
        let currentChartFilter = 'monthly';
        let currentSearchMember = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('adm-point-date').value = today;
            
            await loadData(); // Fetch Cloud
            renderDashboard();
            renderAdminLists();
            initChart(currentChartFilter);

            // Realtime
            _supabase.channel('public:all').on('postgres_changes', { event: '*', schema: 'public' }, async () => {
                await loadData();
                renderDashboard();
                renderAdminLists();
                initChart(currentChartFilter);
                if(currentSearchMember) searchNIM();
            }).subscribe();
        });

        // --- FETCH DATA ---
        async function loadData() {
            document.getElementById('connection-status').innerText = "Menyinkronkan data...";
            
            let { data: dbMembers, error: e1 } = await _supabase.from('members').select('*');
            let { data: dbLogs, error: e2 } = await _supabase.from('point_logs').select('*');
            let { data: dbProkers, error: e3 } = await _supabase.from('prokers').select('*');

            if(e1 || e2 || e3) {
                document.getElementById('connection-status').innerText = "Gagal Koneksi!";
                return;
            }

            members = dbMembers.map(m => ({
                ...m,
                pointHistory: dbLogs.filter(l => l.nim === m.nim)
            }));
            prokers = dbProkers;

            document.getElementById('connection-status').innerText = "Terhubung ke Database LITBANG-KBSI...";
            document.getElementById('connection-status').className = "bg-green-100 text-green-800 text-xs text-center py-1 font-medium";
        }

        // --- HELPERS ---
        function parseDate(str) {
            if (!str) return new Date();
            const parts = str.split('-');
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        function formatDateLocal(dateObj) {
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        // LOGIC: ACTIVITY SPIKE (POINTS IN PERIOD)
        function getPointsInPeriod(member, start, end) {
            if (!member.pointHistory) return 0;
            let e = new Date(end); e.setHours(23, 59, 59, 999);
            let s = new Date(start); s.setHours(0, 0, 0, 0);
            return member.pointHistory.reduce((acc, curr) => {
                let pDate = parseDate(curr.date);
                if (pDate >= s && pDate <= e) return acc + curr.val;
                return acc;
            }, 0);
        }

        // LOGIC: CUMULATIVE TOTAL (LEADERBOARD)
        function getCumulativePointsUntil(member, dateLimitStr) {
            if (!member.pointHistory) return 0;
            let limit = new Date(dateLimitStr); limit.setHours(23, 59, 59, 999);
            return member.pointHistory.reduce((acc, curr) => {
                if(parseDate(curr.date) <= limit) return acc + curr.val;
                return acc;
            }, 0);
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        // --- CHART DATA GENERATOR (AGGREGATION) ---
        function generatePeriodData(memberList, timeframe, isGlobal) {
            let labels = [];
            let dataPoints = [];
            let bucketEndDates = []; 
            const today = new Date();
            
            // Fixed Counts
            let count = (timeframe === 'yearly') ? 5 : 6; // 5 Years, 6 Months, 6 Weeks
            
            for (let i = count - 1; i >= 0; i--) {
                let startDate, endDate, label;
                let d = new Date();

                if (timeframe === 'weekly') {
                    d.setDate(today.getDate() - (i * 7));
                    endDate = new Date(d);
                    startDate = new Date(d); startDate.setDate(endDate.getDate() - 6);
                    label = `W-${getWeekNumber(endDate)}`;
                } else if (timeframe === 'monthly') {
                    d.setMonth(today.getMonth() - i);
                    startDate = new Date(d.getFullYear(), d.getMonth(), 1);
                    endDate = new Date(d.getFullYear(), d.getMonth() + 1, 0);
                    label = startDate.toLocaleDateString(localeID, { month: 'short', year: '2-digit' });
                } else { 
                    d.setFullYear(today.getFullYear() - i);
                    startDate = new Date(d.getFullYear(), 0, 1);
                    endDate = new Date(d.getFullYear(), 11, 31);
                    label = d.getFullYear().toString();
                }

                labels.push(label);
                bucketEndDates.push(formatDateLocal(endDate));

                let val = 0;
                if (isGlobal) {
                    val = memberList.reduce((sum, m) => sum + getPointsInPeriod(m, startDate, endDate), 0);
                } else {
                    val = getPointsInPeriod(memberList, startDate, endDate);
                }
                dataPoints.push(val);
            }

            return { labels, dataPoints, bucketEndDates };
        }

        // --- CHART RENDERERS ---
        function updateChartFilter(type) {
            currentChartFilter = type;
            document.querySelectorAll('.chart-filter').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                btn.classList.add('text-gray-600');
            });
            event.target.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
            event.target.classList.remove('text-gray-600');
            initChart(type);
        }

        function initChart(timeframe) {
            const ctx = document.getElementById('sdmChart').getContext('2d');
            const data = generatePeriodData(members, timeframe, true);

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Aktivitas Organisasi',
                        data: data.dataPoints,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        fill: true,
                        tension: 0.2 // Kurva halus tapi responsif
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const idx = activeEls[0].index;
                            renderDashboard(data.bucketEndDates[idx]); // TIME TRAVEL
                        } else {
                            renderDashboard(null);
                        }
                    }
                }
            });
        }

        function renderPersonalChart(timeframe) {
            if(!currentSearchMember) return;
            const ctx = document.getElementById('personalChart').getContext('2d');
            const data = generatePeriodData(currentSearchMember, timeframe, false);

            if(personalChartInstance) personalChartInstance.destroy();
            personalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Aktivitas Individu',
                        data: data.dataPoints,
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderColor: '#4f46e5',
                        borderWidth: 2,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        }

        function renderInterestRadar(member) {
            const ctx = document.getElementById('interestRadarChart').getContext('2d');
            const categories = {
                'Aktif Forum': ['Rapat Bulanan', 'Konsolidasi'],
                'Kritis': ['Saran Forum Divisi', 'Saran Forum Umum'],
                'Kepanitiaan': ['Anggota Panitia', 'Sidang Pleno Panitia'],
                'Kepemimpinan': ['Sekretaris Panitia', 'Bendahara Panitia', 'Ketua Panitia', 'Kepala Divisi panitia'],
                'Revolusioner': ['Inovasi']
            };
            let scores = [0, 0, 0, 0, 0];
            
            if(member.pointHistory) {
                member.pointHistory.forEach(h => {
                    if(categories['Aktif Forum'].includes(h.source)) scores[0] += h.val;
                    else if(categories['Kritis'].includes(h.source)) scores[1] += h.val;
                    else if(categories['Kepanitiaan'].includes(h.source)) scores[2] += h.val;
                    else if(categories['Kepemimpinan'].includes(h.source)) scores[3] += h.val;
                    else if(categories['Revolusioner'].includes(h.source)) scores[4] += h.val;
                });
            }

            if(interestRadarChart) interestRadarChart.destroy();
            interestRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Aktif Forum', 'Kritis', 'Kepanitiaan', 'Kepemimpinan', 'Revolusioner'],
                    datasets: [{
                        label: 'Peta Minat',
                        data: scores,
                        fill: true,
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        borderColor: '#4f46e5',
                        pointBackgroundColor: '#4f46e5',
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { angleLines: { display: true }, suggestedMin: 0, ticks: { display: false, backdropColor: 'transparent' } } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // --- DASHBOARD RENDERER ---
        function renderDashboard(filterDate = null) {
            const labelMode = document.getElementById('display-mode-label');
            const btnReset = document.getElementById('btn-reset-view');
            let dateLimit = filterDate || formatDateLocal(new Date());

            if (filterDate) {
                let d = parseDate(filterDate);
                labelMode.innerHTML = `HISTORIS: ${d.toLocaleDateString(localeID, { day: 'numeric', month: 'long', year: 'numeric' })}`;
                labelMode.className = "text-sm font-bold text-purple-600 bg-purple-100 px-3 py-1 rounded-full border border-purple-200";
                btnReset.classList.remove('hidden');
            } else {
                labelMode.innerHTML = "LIVE (Hari Ini)";
                labelMode.className = "text-sm font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full border border-green-200";
                btnReset.classList.add('hidden');
            }

            let sortedMembers = [...members].sort((a, b) => getCumulativePointsUntil(b, dateLimit) - getCumulativePointsUntil(a, dateLimit));
            let tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = "";
            let displayCount = 0;
            sortedMembers.forEach((m, index) => {
                if (displayCount < 10) {
                    let pts = getCumulativePointsUntil(m, dateLimit);
                    
                    // --- PERBAIKAN: Logika Peringkat & Medali ---
                    let rank = index + 1; // Membuat angka urut (Index dimulai dari 0, jadi tambah 1)
                    let rankDisplay = rank; // Defaultnya angka biasa (4, 5, 6...)
                    
                    // Jika Juara 1-3, tambahkan medali
                    if(rank === 1) rankDisplay = "1";
                    else if(rank === 2) rankDisplay = "2";
                    else if(rank === 3) rankDisplay = "3";

                    // Beri warna background biru tipis untuk 3 teratas agar spesial
                    let rowClass = rank <= 3 ? "bg-blue-50" : "hover:bg-gray-50";
                    let textClass = rank <= 3 ? "text-blue-900 font-bold" : "text-gray-500";

                    // Masukkan ke HTML
                    tbody.innerHTML += `
                        <tr class="${rowClass} border-b transition">
                            <td class="px-4 py-3 text-sm ${textClass}">${rankDisplay}</td>
                            <td class="px-4 py-3 text-sm text-gray-900 font-medium">${m.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-500 text-xs uppercase">${m.div}</td>
                            <td class="px-4 py-3 text-right text-sm font-bold text-indigo-600">${pts}</td>
                        </tr>`;
                    // ---------------------------------------------

                    displayCount++;
                }
            });

            let prokerList = document.getElementById('proker-list');
            prokerList.innerHTML = "";
            let sortedProkers = [...prokers].sort((a,b) => parseDate(a.date) - parseDate(b.date));
            sortedProkers.forEach(p => {
                let isDone = p.status === 'Selesai';
                let dateObj = parseDate(p.date);
                let day = dateObj.getDate();
                let month = dateObj.toLocaleDateString(localeID, { month: 'short' });
                prokerList.innerHTML += `<li class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:shadow-sm transition"><div class="flex-shrink-0 w-12 text-center bg-gray-50 rounded p-1"><span class="block text-xs font-bold text-gray-400 uppercase">${month}</span><span class="block text-lg font-bold text-gray-800 leading-none">${day}</span></div><div class="flex-1 min-w-0"><div class="flex justify-between"><p class="text-sm font-bold text-gray-800 truncate">${p.name}</p><span class="text-[10px] ${isDone ? 'text-green-600 bg-green-50' : 'text-orange-600 bg-orange-50'} px-2 py-0.5 rounded-full font-bold">${p.status}</span></div><p class="text-xs text-gray-500 mt-1 line-clamp-2">${p.desc || "Tidak ada keterangan."}</p></div></li>`;
            });
        }
        function resetLeaderboardView() { renderDashboard(null); }

        // --- SEARCH & ADMIN ---
        function searchNIM() {
            let val = document.getElementById('nim-input').value.trim();
            let m = members.find(x => x.nim === val);
            if(m) {
                currentSearchMember = m; 
                document.getElementById('search-result').classList.remove('hidden');
                document.getElementById('search-error').classList.add('hidden');
                document.getElementById('res-name').innerText = m.name;
                document.getElementById('res-nim').innerText = m.nim;
                document.getElementById('res-role').innerText = m.role;
                document.getElementById('res-div').innerText = m.div;
                document.getElementById('res-total-points').innerText = getCumulativePointsUntil(m, formatDateLocal(new Date()));
                document.getElementById('res-achievements').innerText = m.achievements;
                document.getElementById('res-photo').src = m.photo || defaultPhoto;

                let histBody = document.getElementById('res-points-history');
                histBody.innerHTML = "";
                m.pointHistory.sort((a,b) => parseDate(b.date) - parseDate(a.date)).forEach(h => {
                    histBody.innerHTML += `<tr><td class="px-3 py-2 text-gray-500 text-xs">${h.date}</td><td class="px-3 py-2 text-gray-700">${h.source}</td><td class="px-3 py-2 text-right font-bold text-indigo-600">+${h.val}</td></tr>`;
                });
                renderPersonalChart('monthly'); // Default Monthly
                renderInterestRadar(m);
            } else {
                currentSearchMember = null;
                document.getElementById('search-result').classList.add('hidden');
                document.getElementById('search-error').classList.remove('hidden');
            }
        }

        async function saveMember() {
            const btn = document.getElementById('btn-save-member'); btn.innerText = "Menyimpan..."; btn.disabled = true;
            let nim = document.getElementById('adm-nim').value.trim();
            let name = document.getElementById('adm-name').value.trim();
            let div = document.getElementById('adm-div').value;
            let role = document.getElementById('adm-role').value;
            let ach = document.getElementById('adm-achievements').value.trim();
            let pointAction = document.getElementById('adm-point-action').value.split('|');
            let pointVal = parseInt(pointAction[0]);
            let pointSource = pointAction[1];
            let pointDate = document.getElementById('adm-point-date').value;
            let fileInput = document.getElementById('adm-photo');

            if(!nim || !name) { alert("NIM & Nama wajib diisi."); btn.innerText="SIMPAN"; btn.disabled=false; return; }

            let photoBase64 = null;
            if(fileInput.files.length > 0) {
                photoBase64 = await new Promise((resolve) => {
                    let r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsDataURL(fileInput.files[0]);
                });
            }

            let upsertData = { nim, name, div, role, achievements: ach };
            if(photoBase64) upsertData.photo = photoBase64;

            let { data: existing } = await _supabase.from('members').select('id').eq('nim', nim).single();
            if(existing) await _supabase.from('members').update(upsertData).eq('nim', nim);
            else await _supabase.from('members').insert([upsertData]);

            if(pointVal > 0) await _supabase.from('point_logs').insert([{ nim, source: pointSource, val: pointVal, date: pointDate }]);

            alert("Berhasil!");
            btn.innerText = "SIMPAN"; btn.disabled = false;
            document.getElementById('form-member').reset();
            document.getElementById('adm-point-date').value = new Date().toISOString().split('T')[0];
        }

        // --- KODE PERBAIKAN FUNGSI TAMBAH PROKER ---
        async function addProker() {
            // 1. Ambil Data dari Input
            let name = document.getElementById('adm-prog-name').value;
            let date = document.getElementById('adm-prog-date').value;
            let status = document.getElementById('adm-prog-status').value;
            let desc = document.getElementById('adm-prog-desc').value;

            // 2. Validasi: Cek apakah nama & tanggal diisi
            if (!name || !date) {
                alert("?? Wajib isi Nama Program dan Tanggal!");
                return;
            }

            // 3. Ubah Tombol jadi Loading (Supaya tau sedang proses)
            // Kita cari tombol di dalam form proker
            const btn = document.querySelector('#form-proker button'); 
            const textAsli = btn.innerText;
            btn.innerText = "Menyimpan...";
            btn.disabled = true;

            try {
                // 4. Kirim ke Supabase dengan Error Checking
                const { error } = await _supabase
                    .from('prokers')
                    .insert([{ 
                        name: name, 
                        date: date, 
                        status: status, 
                        desc: desc 
                    }]);

                if (error) {
                    throw error; // Jika database menolak, lempar ke catch
                }

                // 5. SUKSES: Refresh Data Manual
                alert("? Proker Berhasil Ditambahkan!");
                document.getElementById('form-proker').reset(); // Kosongkan form
                
                // Paksa website mengambil data terbaru & gambar ulang tampilan
                await loadData(); 
                renderDashboard(); 
                renderAdminLists();

            } catch (err) {
                // 6. JIKA GAGAL
                console.error("Error Upload:", err);
                alert("? Gagal menyimpan: " + err.message);
            } finally {
                // 7. Kembalikan Tombol seperti semula
                btn.innerText = textAsli;
                btn.disabled = false;
            }
        }

       // --- FUNGSI HAPUS DATA (UPDATE V5.5) ---
        
        // 1. Hapus Anggota
        async function deleteMember(index) {
            const m = members[index];
            if(!m) return;
            
            if(confirm(`HAPUS ANGGOTA\nNama: ${m.name}\n\nData yang dihapus tidak bisa dikembalikan.`)) {
                // Hapus dari Supabase
                const { error } = await _supabase.from('members').delete().eq('nim', m.nim);
                
                if(error) {
                    alert("Gagal menghapus: " + error.message);
                } else {
                    alert("Anggota berhasil dihapus.");
                    await loadData(); // Refresh data
                    renderAdminLists(); // Update tabel
                    renderDashboard(); // Update grafik
                }
            }
        }

        // 2. Hapus Proker
        async function deleteProker(index) {
            const p = prokers[index];
            if(!p) return;

            if(confirm(`HAPUS PROKER\nProgram: ${p.name}`)) {
                const { error } = await _supabase.from('prokers').delete().eq('id', p.id);
                
                if(error) {
                    alert("Gagal menghapus.");
                } else {
                    alert("Proker dihapus.");
                    await loadData();
                    renderAdminLists();
                    renderDashboard();
                }
            }
        }

        // 3. Reset Total
        async function resetAllData() {
            let konfirmasi = prompt("KETIK 'HAPUS' UNTUK MERESET SEMUA DATA:");
            if(konfirmasi === 'HAPUS') {
                await _supabase.from('point_logs').delete().neq('id', 0);
                await _supabase.from('prokers').delete().neq('id', 0);
                await _supabase.from('members').delete().neq('id', 0);
                alert("Database Bersih!");
                location.reload();
            } else {
                alert("Batal.");
            }
        }

        // --- RENDER TABEL ADMIN (TOMBOL DIPERBESAR) ---
        function renderAdminLists() {
            // List Anggota
            let mlist = document.getElementById('admin-member-list'); 
            mlist.innerHTML = "";
            
            if(members.length === 0) {
                mlist.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-slate-400 italic">Belum ada data anggota</td></tr>`;
            } else {
                members.forEach((m, i) => {
                    mlist.innerHTML += `
                        <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                            <td class="p-3">
                                <div class="text-sm font-bold text-slate-700">${m.name}</div>
                                <div class="text-xs text-slate-500 font-mono">${m.nim}</div>
                            </td>
                            <td class="p-3 text-center">
                                <button onclick="deleteMember(${i})" class="bg-red-100 text-red-600 hover:bg-red-600 hover:text-white p-2 rounded-lg transition shadow-sm" title="Hapus Anggota">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>`;
                });
            }

            // List Proker
            let plist = document.getElementById('admin-proker-list'); 
            plist.innerHTML = "";

            if(prokers.length === 0) {
                plist.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-slate-400 italic">Belum ada proker</td></tr>`;
            } else {
                prokers.forEach((p, i) => {
                    plist.innerHTML += `
                        <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                            <td class="p-3">
                                <div class="text-sm font-bold text-slate-700">${p.name}</div>
                                <div class="text-xs text-slate-500">${parseDate(p.date).toLocaleDateString()}</div>
                            </td>
                            <td class="p-3 text-center">
                                <button onclick="deleteProker(${i})" class="bg-red-100 text-red-600 hover:bg-red-600 hover:text-white p-2 rounded-lg transition shadow-sm" title="Hapus Proker">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>`;
                });
            }
        }

        function switchTab(id) {
            document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-' + id).classList.remove('hidden');
            if(id !== 'admin') {
                document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active-tab', 'text-gray-900'); b.classList.add('text-gray-500'); });
                document.getElementById('btn-' + id).classList.add('active-tab', 'text-gray-900');
            }
        }
        function accessAdmin() { if(prompt("Password:") === "admin123") switchTab('admin'); else alert("Salah"); }
        
        function seedDemoData() {
            let lastM = new Date(); lastM.setMonth(lastM.getMonth()-1);
            members = [{ nim: "101", name: "Budi Demo", div: "Humas", role: "Anggota", achievements: "-", pointHistory: [{source: "Rapat Bulanan", val: 1, date: formatDateLocal(lastM)}, {source: "Inovasi", val: 5, date: formatDateLocal(new Date())}], photo: "" }];
            prokers = [{ name: "Webinar", date: formatDateLocal(new Date()), status: "Belum", desc: "Contoh keterangan proker." }];
            saveData();
        }
</script>
</body>
</html>
